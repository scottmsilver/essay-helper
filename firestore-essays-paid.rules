rules_version = '2';
service cloud.firestore {
  match /databases/essays-paid/documents {
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper to check if essay is public
    function isPublic(essayData) {
      return essayData.sharing != null && essayData.sharing.isPublic == true;
    }

    // Helper to check if essay allows public editing
    function isPublicEditor(essayData) {
      return isPublic(essayData) && essayData.sharing.publicPermission == 'editor';
    }

    // Helper to check if user email is in collaborators list
    function isCollaboratorEmail(essayData) {
      return request.auth != null &&
             essayData.sharing != null &&
             essayData.sharing.collaboratorEmails != null &&
             request.auth.token.email in essayData.sharing.collaboratorEmails;
    }

    // Helper to check if user is an editor
    function isEditorEmail(essayData) {
      return request.auth != null &&
             essayData.sharing != null &&
             essayData.sharing.editorEmails != null &&
             request.auth.token.email in essayData.sharing.editorEmails;
    }

    // User essays collection
    match /users/{userId}/essays/{essayId} {
      // Owner has full access
      allow read, write: if isOwner(userId);

      // Collaborators can read
      allow read: if isCollaboratorEmail(resource.data);

      // Editors can update (except sharing field)
      allow update: if isEditorEmail(resource.data) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['sharing']);

      // Public essays can be read by anyone
      allow read: if isPublic(resource.data);

      // Public editors can update (except sharing field)
      allow update: if isPublicEditor(resource.data) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['sharing']);

      // Comments subcollection
      match /comments/{commentId} {
        // Helper to get the parent essay data
        function getEssay() {
          return get(/databases/essays-paid/documents/users/$(userId)/essays/$(essayId)).data;
        }

        // Helper to validate comment author matches authenticated user
        function isValidAuthor() {
          return request.resource.data.authorUid == request.auth.uid;
        }

        // Helper to check if user can only edit their own comments
        function isCommentAuthor() {
          return resource.data.authorUid == request.auth.uid;
        }

        // Owner has full access to comments
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && isValidAuthor();
        allow update, delete: if isOwner(userId);

        // Collaborators can read comments
        allow read: if isCollaboratorEmail(getEssay());

        // Editors can read and create (with valid author), update/delete only their own
        allow read: if isEditorEmail(getEssay());
        allow create: if isEditorEmail(getEssay()) && isValidAuthor();
        allow update, delete: if isEditorEmail(getEssay()) && isCommentAuthor();

        // Public essays: anyone can read
        allow read: if isPublic(getEssay());
        // Public editors can create (with valid author), update/delete only their own
        allow create: if isPublicEditor(getEssay()) && request.auth != null && isValidAuthor();
        allow update, delete: if isPublicEditor(getEssay()) && request.auth != null && isCommentAuthor();
      }
    }

    // Shared with me references - indexed by recipient email (lowercase)
    match /sharedWithMe/{recipientEmail}/essays/{docId} {
      // Users can only read their own shared items
      allow read: if request.auth != null &&
                     request.auth.token.email.lower() == recipientEmail;
      // Essay owners can write to share with others
      allow write: if request.auth != null;
    }

    // Public essay lookup - maps token to essay location
    match /publicEssays/{publicToken} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
                               request.auth.uid == resource.data.ownerUid;
    }

    // Essay index for unified URL lookups - maps essayId to ownerUid
    match /essayIndex/{essayId} {
      allow read: if true;
      allow create: if request.auth != null &&
                       request.resource.data.ownerUid == request.auth.uid;
      allow update, delete: if request.auth != null &&
                               resource.data.ownerUid == request.auth.uid;
    }
  }
}
